Data Source=SE-MAIN\SPED;Initial Catalog=LvsHonselmann;Persist Security Info=True;User ID=sa;Password=masterkey

sqlArtikelSource:
=======================
DECLARE @AuftraggeberID as int;
DECLARE @Stichtag as Datetime;
SET @AuftraggeberID=19;
SET @Stichtag = CAST('07.07.2014' as DATETIME);

Select a.*
, CONVERT(varchar(10), c.[Date], 104) as Eingangsdatum
,CASE WHEN IsVerpackt = 1
      THEN 'Bemerkung: ist verpackt' + char(13)
      ELSE ''
      END as Verpackt
,CASE WHEN (SELECT COUNT (*)
	    FROM Artikel a1
	    INNER JOIN LEingang c1 on c1.ID=a1.LEingangTableID
	    INNER JOIN SchadenZuweisung d1 ON d1.ArtikelID=a1.ID
	    INNER JOIN Schaeden e1 ON e1.ID=d1.SchadenID
	    WHERE c1.Auftraggeber=@AuftraggeberID) > 0
      THEN 'Schaden: ' + STUFF((SELECT ', ' + e2.Bezeichnung
				FROM Artikel a2
				INNER JOIN LEingang c1 on c1.ID=a2.LEingangTableID
				LEFT OUTER JOIN SchadenZuweisung d2 ON d2.ArtikelID=a2.ID
				LEFT OUTER JOIN Schaeden e2 ON e2.ID=d2.SchadenID
				WHERE c1.Auftraggeber=@AuftraggeberID
				FOR XML PATH (''))
			  ,1,2,'') 
      ELSE ''
      END as Schaden
, STUFF(	
			(SELECT ', ' + CAST(e1.ID as nvarchar)
				FROM Artikel a1
				INNER JOIN LEingang c1 ON c1.ID=a1.LEingangTableID
				INNER JOIN SchadenZuweisung d1 ON d1.ArtikelID=a1.ID
				INNER JOIN Schaeden e1 ON e1.ID=d1.SchadenID
				WHERE a1.ID=a.ID 
				Order By e1.ID
				FOR XML PATH ('')
			 )
		,1,2,'') as Anmerkung
, CASE
	WHEN (a.Laenge>0)
		THEN CAST(a.Dicke as varchar (20))+' x '+ CAST(CAST(a.Breite as int) as varchar(20))+' x '+CAST(CAST(a.Laenge as int) as varchar(20))
	
	ELSE CAST(a.Dicke as varchar (20))+' x '+ CAST(Cast(a.Breite as int) as varchar(20))
	END as Abmessung
	,c.[Date]
	,d.Datum
FROM Artikel a
Left JOIN LEingang c ON c.ID=a.LEingangTableID
Left Join LAusgang d ON d.ID=a.LAusgangTableID
WHERE c.Auftraggeber=@AuftraggeberID 
AND Cast(c.[Date] as Date)=Cast(@Datum as Date)

UNION

Select a.*
, CONVERT(varchar(10), c.[Date], 104) as Eingangsdatum
,CASE WHEN IsVerpackt = 1
      THEN 'Bemerkung: ist verpackt' + char(13)
      ELSE ''
      END as Verpackt
,CASE WHEN (SELECT COUNT (*)
	    FROM Artikel a1
	    INNER JOIN LEingang c1 on c1.ID=a1.LEingangTableID
	    INNER JOIN SchadenZuweisung d1 ON d1.ArtikelID=a1.ID
	    INNER JOIN Schaeden e1 ON e1.ID=d1.SchadenID
	    WHERE c1.Auftraggeber=@AuftraggeberID) > 0
      THEN 'Schaden: ' + STUFF((SELECT ', ' + e2.Bezeichnung
				FROM Artikel a2
				INNER JOIN LEingang c1 on c1.ID=a2.LEingangTableID
				LEFT OUTER JOIN SchadenZuweisung d2 ON d2.ArtikelID=a2.ID
				LEFT OUTER JOIN Schaeden e2 ON e2.ID=d2.SchadenID
				WHERE c1.Auftraggeber=@AuftraggeberID
				FOR XML PATH (''))
			  ,1,2,'') 
      ELSE ''
      END as Schaden
, STUFF(	
			(SELECT ', ' + CAST(e1.ID as nvarchar)
				FROM Artikel a1
				INNER JOIN LEingang c1 ON c1.ID=a1.LEingangTableID
				INNER JOIN SchadenZuweisung d1 ON d1.ArtikelID=a1.ID
				INNER JOIN Schaeden e1 ON e1.ID=d1.SchadenID
				WHERE a1.ID=a.ID 
				Order By e1.ID
				FOR XML PATH ('')
			 )
		,1,2,'') as Anmerkung
, CASE
	WHEN (a.Laenge>0)
		THEN CAST(a.Dicke as varchar (20))+' x '+ CAST(CAST(a.Breite as int) as varchar(20))+' x '+CAST(CAST(a.Laenge as int) as varchar(20))
	
	ELSE CAST(a.Dicke as varchar (20))+' x '+ CAST(Cast(a.Breite as int) as varchar(20))
	END as Abmessung
	,c.[Date]
	,d.Datum
FROM Artikel a
Left JOIN LEingang c ON c.ID=a.LEingangTableID
Left Join LAusgang d ON d.ID=a.LAusgangTableID
WHERE c.Auftraggeber=@AuftraggeberID 
AND  Cast(d.Datum as Date)=Cast(@Datum as Date)



sqlLAusgangSource
====================

SET @strTmp='';
SET @strTmp =(SELECT Fbez FROM ADR WHERE ID=@AuftraggeberID);
IF((@strTmp<>'')) SET @strADRAuftraggeber =@strTmp;
SET @strTmp='';
SET @strTmp =(SELECT Name1 FROM ADR WHERE ID=@AuftraggeberID);
IF((@strTmp<>'')) SET @strADRAuftraggeber =@strADRAuftraggeber + nchar(13) + nchar(10)+ @strTmp;
SET @strTmp='';
SET @strTmp =(SELECT Name2 FROM ADR WHERE ID=@AuftraggeberID);
IF((@strTmp<>'')) SET @strADRAuftraggeber =@strADRAuftraggeber + nchar(13) + nchar(10)+ @strTmp;
SET @strTmp='';
SET @strTmp =(SELECT Name3 FROM ADR WHERE ID=@AuftraggeberID);
IF((@strTmp<>'')) SET @strADRAuftraggeber =@strADRAuftraggeber + nchar(13) + nchar(10)+ @strTmp;
SET @strTmp='';
SET @strTmp =(SELECT Str + ' '+HausNr FROM ADR WHERE ID=@AuftraggeberID);
IF((@strTmp<>'')) SET @strADRAuftraggeber =@strADRAuftraggeber + nchar(13) + nchar(10)+ @strTmp + nchar(13) + nchar(10);
SET @strTmp='';
SET @strTmp =(SELECT PLZ + ' '+Ort FROM ADR WHERE ID=@AuftraggeberID);
IF((@strTmp<>'')) SET @strADRAuftraggeber = @strADRAuftraggeber + nchar(13) + nchar(10)+ @strTmp;

Select 
    @schaden = COALESCE(@schaden + ', ', '') + (Cast( ID as nvarchar) + ': ' + Bezeichnung)  
FROM 
    Schaeden
WHERE 
	aktiv=1;

SELECT 
*
, @strADRAuftraggeber as AAdressblock
, @schaden as Anmerkung
FROM Adr
WHERE ID=@AuftraggeberID;